name: Deploy to Kubernetes

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # ============================================================================
  # LAB
  # ============================================================================
  deploy-lab-gate:
    name: ğŸš¦ Approve (lab)
    runs-on: ubuntu-latest
    environment: lab
    steps:
      - name: Approved
        run: echo "Deployment to lab approved"

  deploy-lab:
    name: ğŸš€ Deploy (lab)
    needs: deploy-lab-gate
    uses: ./.github/workflows/deploy-environment.yaml
    with:
      environment: lab
    secrets: inherit

  # ============================================================================
  # DEV
  # ============================================================================
  deploy-dev-gate:
    name: ğŸš¦ Approve (dev)
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Approved
        run: echo "Deployment to dev approved"

  deploy-dev:
    name: ğŸš€ Deploy (dev)
    needs: deploy-dev-gate
    uses: ./.github/workflows/deploy-environment.yaml
    with:
      environment: dev
    secrets: inherit

  # ============================================================================
  # QS
  # ============================================================================
  deploy-qs-gate:
    name: ğŸš¦ Approve (qs)
    runs-on: ubuntu-latest
    environment: qs
    steps:
      - name: Approved
        run: echo "Deployment to qs approved"

  deploy-qs:
    name: ğŸš€ Deploy (qs)
    needs: deploy-qs-gate
    uses: ./.github/workflows/deploy-environment.yaml
    with:
      environment: qs
    secrets: inherit

  # ============================================================================
  # PROD
  # ============================================================================
  deploy-prod-gate:
    name: ğŸš¦ Approve (prod)
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Approved
        run: echo "Deployment to prod approved"

  deploy-prod-documentation:
    name: ğŸ“ Documentation (prod)
    runs-on: ubuntu-latest
    needs: deploy-prod-gate
    steps:
      - name: Generate deployment documentation
        run: |
          echo "TODO: Generate deployment documentation"
          # - Create changelog
          # - Document deployed version
          # - Create release notes

      - name: Publish documentation
        run: |
          echo "TODO: Publish documentation"
          # - Upload to wiki/confluence/etc.

  deploy-prod:
    name: ğŸš€ Deploy (prod)
    needs: deploy-prod-documentation
    uses: ./.github/workflows/deploy-environment.yaml
    with:
      environment: prod
    secrets: inherit
